#!/bin/bash

# Function to update a Git repository
update_git_repo() {
    local repo_dir="$1"
    echo "########################################################"
    echo "Updating $repo_dir"

    if [ -d "$repo_dir/.git" ]; then
        (
            cd "$repo_dir" || exit
            if git rev-parse --verify main >/dev/null 2>&1; then
                primary_branch="main"
            elif git rev-parse --verify master >/dev/null 2>&1; then
                primary_branch="master"
            else
                echo "Primary branch not found in $repo_dir"
                return 1
            fi

            git checkout "$primary_branch" || { echo "Failed to switch to $primary_branch branch in $repo_dir"; return 1; }
            if git pull; then
                echo "Update successful: $repo_dir"
            else
                echo "Failed to pull changes in $repo_dir"
            fi
        )
    else
        echo "Not a Git repository: $repo_dir"
    fi
}

# Export the function to make it available to parallel
export -f update_git_repo

# Update repositories in parallel
find ~/gitwork/* -maxdepth 2 -type d -exec bash -c 'update_git_repo "$0"' {} \;
